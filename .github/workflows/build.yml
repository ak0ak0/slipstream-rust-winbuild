name: Build Windows Client (Final Attempt)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      OPENSSL_NO_VENDOR: 0
      PICOQUIC_AUTO_BUILD: 1
      LIBCLANG_PATH: 'C:\Program Files\LLVM\bin'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install System Tools
        run: |
          choco install nasm llvm strawberryperl protoc -y
          # حذف فایل لینک مزاحم گیت برای جلوگیری از ارور قبلی
          rm -f "C:/Program Files/Git/usr/bin/link.exe"
        shell: bash # استفاده از بش برای حذف فایل

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1 # آماده‌سازی کامپایلر مایکروسافت

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build Binary
        # نکته طلایی: اجرای کل بیلد در محیط بش برای حل ارور 193
        shell: bash
        run: |
          # اضافه کردن مسیرهای ضروری به ترتیب اولویت
          export PATH="/c/Program Files/LLVM/bin:/c/NASM:/c/Strawberry/perl/bin:$PATH"
          
          # تنظیم متغیرهای محیطی برای کلنگ و اسمبلر
          export CC=cl
          export CXX=cl
          export NASM=nasm
          
          # اجرای بیلد نهایی
          cargo build --release --features openssl/vendored

      - name: Upload EXE
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-windows
          path: target/release/*.exe
